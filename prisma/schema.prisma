generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("MYSQL_URL")
}

model User {
  id  Int    @id @default(autoincrement())
  uid String @unique @default(uuid())

  displayName String? // Common name for user's display name (not username which implies uniqueness)
  avatar      String? @db.Text

  email    String? @unique
  phone    String? @unique
  gitHubId String? @unique
  googleId String? @unique
  appleId  String? @unique

  // 2FA support
  twoFactorEnabled Boolean @default(false)
  twoFactorSecret  String?

  // User status
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  passkeys Passkey[]
  wallet   Wallet?

  @@map("users")
}

model Passkey {
  id             String @id @db.VarChar(255) // Base64URLString
  publicKey      Bytes // 存储为二进制数据，对应 Uint8Array
  webAuthnUserID String @db.VarChar(255) // Base64URLString
  counter        BigInt @default(0) // 使用 BigInt 来应对 timestamp 作为计数器的情况

  // WebAuthn additional fields
  transports String? @db.VarChar(255) // JSON字符串格式存储传输方式数组,'ble' | 'cable' | 'hybrid' | 'internal' | 'nfc' | 'smart-card' | 'usb'
  deviceType String  @default("singleDevice") @db.VarChar(32) // singleDevice 或 multiDevice
  backedUp   Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user   User @relation(fields: [userId], references: [id])
  userId Int

  @@unique([webAuthnUserID, userId]) // 联合唯一约束提高用户隐私保护
  @@index([id])
  @@index([webAuthnUserID])
  @@index([userId])
  @@map("passkeys")
}

model Wallet {
  id        Int      @id @default(autoincrement())
  balance   Decimal  @default(0) @db.Decimal(12, 6) // 余额，精确到小数点后6位
  version   Int      @default(1) // 乐观锁版本号，用于并发控制
  updatedAt DateTime @updatedAt

  // 关联字段
  user   User @relation(fields: [userId], references: [id])
  userId Int  @unique

  @@map("wallets")
}
